---
layout: post
date: 2017-11-28 00:00
title: Graph API
tags:
- office365
- powershell
categories:
- powershell
---

![Banner](/assets/img/2017/office365/graphapi-banner.png#banner)

Microsoft Graph permet de se connecter √† de nombreuses ressources li√©es √† Office 365 (utilisateurs, discussions, calendriers, groupes, etc.)

La d√©nomination ¬´ **Graph** ¬ª vient du fait que toutes ces ressources sont **interconnect√©es**, formant un r√©seau d‚Äôobjets.

Par exemple, pour un utilisateur donn√©, Graph permet d‚Äôacc√©der √† ses messages, son **calendrier**, ses **fichiers**, mais √©galement aux **groupes** auxquels il appartient. Cet utilisateur est √©galement associ√© √† un **manager**, √† un ou plusieurs appareils (PC, t√©l√©phone, etc.), et d‚Äôautres choses encore‚Ä¶

<!--more-->

Ces interconnexions permettent d‚Äôimaginer beaucoup de sc√©narii d‚Äôutilisation. Voici un exemple de repr√©sentation d'interconnexion entre les diff√©rentes zones :
![graphapi-01](/assets/img/2017/office365/graphapi-01.png#center)

√Ä partir du principal point de terminaison (https://graph.microsoft.com), nous pouvons appeler n'importe quelle ressource disponible dont vous avez les autorisations. Cette URL se d√©compose en deux parties:

- Version de la m√©thode
- Nom de la Methode

Dans le tableau suivant, vous trouverez quelques exemples de points de terminaison :

| Op√©ration                               | Points de terminaison                                                                |
| --------------------------------------- | ------------------------------------------------------------------------------------ |
| Tous les utilisateurs de l'organisation | https://graph.microsoft.com/v1.0/users                                               |
| R√©pertorier les salles de conf√©rences   | https://graph.microsoft.com/beta/me/findRooms                                        |
| Tous les Groupes de mon organisation    | https://graph.microsoft.com/v1.0/groups                                              |
| Membre du groupe                        | https://graph.microsoft.com/v1.0/groups/02bd9fd6-8f93-4758-87c3-1fb73740a315/members |
| Mes contacts                            | https://graph.microsoft.com/v1.0/me/contacts                                         |

Sachez que sur son site, Microsoft fournit toute une liste d‚Äôexemples permettant d‚Äôillustrer le potentiel de Graph, vous pouvez trouver plus d'information concernant ces utilisations √† l'adresse suivante : https://developer.microsoft.com/en-us/graph/docs/concepts

## Authentification

### OAuth

OAuth est un protocole libre qui permet d'autoriser une application client √† utiliser l'API s√©curis√©e d'une autre application pour le compte d'un utilisateur.

L'int√©r√™t majeur d'OAuth vient du fait que l'utilisateur n'a plus besoin de fournir ses informations d‚Äôidentification √† une application tierce, car la connexion se passe sur l‚Äôapplication de l'API.

Pour cette **recette** nous utiliserons OAuth pour fournir une authentification √† notre Script/Module Powershell afin de pouvoir ex√©cuter diff√©rentes actions d'administrations.

Ci-dessous un r√©sum√© des flux du protocole OAuth, ce qui vous permettra de mieux comprendre le sc√©nario d'authentification & d'utilisation :

![graphapi-09](/assets/img/2017/office365/graphapi-09.jpg#center)

Pour plus d'information, je vous redirige vers la documentation officiel : https://oauth.net/getting-started

### Application

Pour pouvoir mettre en oeuvre la suite de cette recette nous allons devoir effectuer la cr√©ation d'une application **Azure Active Directory**, ce qui permettra √† nos scripts d'√™tre authentifi√©s via OAuth sur notre Tenant Office365.

Se connecter en tant qu‚Äôadministrateur de son abonnement Azure (*ou un compte avec des privil√®ges suffisants sur l‚ÄôAzure Active Directory*) sur le portail de gestion : https://portal.azure.com

La suite des op√©rations va consister √† cr√©er des *credentials*, c‚Äôest-√†-dire les informations n√©cessaires √† l‚Äôapplication OAuth2 pour s‚Äôauthentifier aupr√®s d‚Äôun abonnement Azure et y faire des op√©rations.

Cela n√©cessite de cr√©er une application dans Azure Active Directory pour g√©n√©rer le **client-id** et le **client-secret**.

Aller dans la partie Azure Active Directory, s√©lectionner l‚ÄôAzure Active Directory concern√© et cliquer sur **App registrations**

![graphapi-02](/assets/img/2017/office365/graphapi-02.png#center)

Puis cliquer sur **Endpoints**.

Sur la ligne **OAUTH 2.0 AUTHORIZATION ENDPOINT**, r√©cup√©rer le **GUID** dans l‚ÄôURL propos√©e. Cette valeur sera le **Tenant-id**.

![graphapi-03](/assets/img/2017/office365/graphapi-03.png#center)

Fermer la lame et cliquer sur **Add**‚Ä¶ pour enregistrer une nouvelle application aupr√®s d‚ÄôAzure Active Directory.

Donner un nom et une URL de Callback quelconque (car non utile dans notre situation) et s√©lectionner **Web app / API** dans la zone Application Type, enfin cliquer sur **Create**.

![graphapi-04](/assets/img/2017/office365/graphapi-04.png#center)

Cliquer ensuite sur l‚Äôapplication qui vient d‚Äô√™tre enregistr√©e, sur cette interface sera affich√©e votre application ID correspondant √† la valeur **client-id**.

![graphapi-05](/assets/img/2017/office365/graphapi-05.png#center)

La suite des op√©rations consiste √† cr√©er une nouvelle cl√© pour cette application.

Saisir une description et choisir une expiration (1 an, 2 ans ou pas d‚Äôexpiration).

![graphapi-06](/assets/img/2017/office365/graphapi-06.png#center)

Cliquer sur **Save**.

L‚Äôinterface va alors d√©voiler un secret qui ne sera expos√© qu‚Äôune seule fois (penser √† faire un copier-coller avant de fermer la lame). Ce secret est la valeur **client-secret**.

!!! danger
    Attention, apr√®s avoir ferm√© la lame, la valeur de la cl√© ne sera pas r√©cup√©rable.
    En cas de perte vous devrez donc recr√©er une nouvelle clef üòì

![graphapi-07](/assets/img/2017/office365/graphapi-07.png#center)

La d√©finition des autorisations se fait √† l'aide du menu **Required permissions** dans les propri√©t√©s de votre application. Pour connaitre les permissions √† accorder je vous invite √† vous r√©f√©rer √† la documentation de la m√©thode que vous souhaiter ex√©cuter.

![graphapi-08](/assets/img/2017/office365/graphapi-08.png#center)

Dans l'exemple ci-dessus, j'ai fourni bien **trop** d'autorisations a mon application, je vous recommande vivement de fournir uniquement les acc√®s que vous avez besoin.

## Exemple de script

### Token

Cette simple fonction Powershell vous permettra d'effectuer une demande d'authentification aupr√®s du Graph API, ce qui vous permettra par la suite de pouvoir ex√©cuter des requ√™tes authentifi√©es.

``` powershell
function Get-OauthToken()
{
    Param(
        [String]$ClientID,
        [String]$ClientSecret,
        [String]$TenantID,
        [String]$Scope="https://graph.microsoft.com/.default",
        [String]$LoginURL="https://login.microsoftonline.com"
    )
    Try {
        # Get an Oauth2 access token based on client id, secret and tenant domain
        $body       = @{grant_type="client_credentials";client_id=$ClientID;client_secret=$ClientSecret;scope=$Scope}
        $oauth      = Invoke-RestMethod -Method Post -Uri "$LoginURL/$TenantID/oauth2/v2.0/token" -Body $body

        if ($oauth.access_token -ne $null) {
            return $oauth
        } else {
            Throw [System.NotImplementedException]::New("Unable to find token : $oauth")
        }
    } Catch {
        Throw [System.NotImplementedException]::New("Unable to get token : $_")
    }
}

$Params = @{
    ClientID     = "0a658d35-XXXX-XXXX-XXXX-91b2679a8e7f"
    ClientSecret = "VnA4URRcZGZZr6GrFvmz1xIwIHSOP/DUBBU="
    TenantID     = "d6eaade4-XXXX-XXXX-XXXX-f000827455bb"
}
$Token = Get-OauthToken @Params
```

### Utilisateurs

La fonction suivante vous permettra de r√©cup√©rer tous les utilisateurs de votre tenant Office365.

``` powershell
function Get-PGUsers {
    Param (
        [Object]$Token
    )
    Try {
        if($Token.access_token -ne $null) {

            # Get User Calandars
            $headerParams = @{'Authorization'="$($Token.token_type) $($Token.access_token)"}
            $url = "https://graph.microsoft.com/v1.0/users"

            $request = Invoke-WebRequest -UseBasicParsing -Headers $headerParams -Uri $url -Method Get

            $calendars = ($request | ConvertFrom-Json).value
            return $calendars
        } else {
            return $false
        }
    } Catch {
        Throw [System.NotImplementedException]::New("Unable to user calandars : $_")
    }
}
Get-PGUsers -Token $token
```

### Templatisation

C'est bien sympa de faire des fonctions monolithiques, mais c'est ce n'est pas tr√®s √©volutif üòÖ, je vous propose donc une alternative dynamique :


``` powershell
function Get-PGRow {
    Param (
        [String]$Version,
        [String]$Method,
        [Object]$Token
    )
    Try {
        if($Token.access_token -ne $null) {

            $headerParams = @{'Authorization'="$($Token.token_type) $($Token.access_token)"}
            $url = "https://graph.microsoft.com/$Version/$Method"

            $request = Invoke-WebRequest -UseBasicParsing -Headers $headerParams -Uri $url -Method Get

            $responce = ($request | ConvertFrom-Json).value
            return $responce
        } else {
            return $false
        }
    } Catch {
        Throw [System.NotImplementedException]::New("Unable to $Method : $_")
    }
}

# Get Users
$Params = @{
    Version = "V1.0"
    Method  = "users"
    Token   = $Token
}
$Users = Get-PGRow @Params

# Get my mail
$Params = @{
    Version = "V1.0"
    Method  = "/users/contact@unicorn.microsoft.com/messages"
    Token   = $Token
}
$MyMessage = Get-PGRow @Params
```

Vous remarquerez rapidement qu'avec l'exemple ci-dessus  nous ne pouvons pas r√©cup√©rer tous les mails du compte. Il vous faudra donc utiliser une autre fonction pour prendre en charge les requ√™tes comportant plusieurs pages.

Voici donc la fonction qui vous permettra de r√©soudre cette probl√©matique :

``` powershell
function Get-PGAll {
    Param (
        [String]$Version,
        [String]$Method,
        [Object]$Token
    )
    Try {

        # Params
        $headerParams = @{'Authorization'="$($Token.token_type) $($Token.access_token)"}
        $url = "https://graph.microsoft.com/$Version/$Method"
        $ReturnObject = @()

        # loop through each query page (1 through n)
        Do{
            # display each url on the console window
            Write-debug "Fetching data using Uri: $url"

            # Request to API Graph
            $Request = (Invoke-WebRequest -UseBasicParsing -Headers $headerParams -Uri $url -Method Get | ConvertFrom-Json)

            $ReturnObject += $Request.value
            $url = $Request.'@odata.nextLink'

        } while(-not([string]::IsNullOrEmpty($url)))

        # Return Object
        return $ReturnObject

    } Catch {
        Throw [System.NotImplementedException]::New("Unable to get API : $_")
    }
}

# Get users delta
$Params = @{
    Version = "V1.0"
    Method  = "/users/delta"
    Token   = $Token
}
$UsersDelta = Get-PGAll @Params
```

Vous connaissez d√©sormais les bases de Microsoft Graph. L‚ÄôAPI √©tant perp√©tuellement en mouvement, de nouveaux sc√©narii d‚Äôutilisation appara√Ætront probablement dans un futur proche pour exploiter pleinement le potentiel d‚ÄôOffice 365.

## Note du Chef

Microsoft vous propose une plateforme  permettant d'explorer les APIs graph sans trop de prise de t√™te, disponible √† l'adresse suivante : https://developer.microsoft.com/en-us/graph/graph-explorer

Je vous souhaite maintenant une bonne exploration de l'univers des APIs Microsoft.
![graphapi-10](/assets/img/2017/office365/graphapi-10.gif#banner)